!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!     Subroutine USDFLD
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
      SUBROUTINE USDFLD(FIELD,STATEV,PNEWDT,DIRECT,T,CELENT,
     + TIME,DTIME,CMNAME,ORNAME,NFIELD,NSTATV,NOEL,NPT,LAYER,
     + KSPT,KSTEP,KINC,NDI,NSHR,COORD,JMAC,JMATYP,MATLAYO,LACCFLA)
      INCLUDE 'ABA_PARAM.INC'
!-----------------------------------------------------------------------
!-----Declaration ABAQUS variables
!-----------------------------------------------------------------------
      CHARACTER*80 CMNAME,ORNAME
      DIMENSION FIELD(NFIELD),STATEV(NSTATV),DIRECT(3,3)
      DIMENSION T(3,3),TIME(2),COORD(*),JMAC(*),JMATYP(*)
!-----Data from ABAQUS
      DIMENSION ARRAY(15),JARRAY(15)
      CHARACTER*3 FLGRAY(15)
!-----------------------------------------------------------------------
!-----Declaration internal variables
!-----------------------------------------------------------------------
      real*8 SIG1
      real*8 PEEQ
      real*8 damage,dp
!-----------------------------------------------------------------------
!-----Declaration material parameters
!-----------------------------------------------------------------------
      real*8 Wc
!-----------------------------------------------------------------------
!     Read material properties
!-----------------------------------------------------------------------
      Wc = 100.0
!-----------------------------------------------------------------------
!     Access principal stresses
!-----------------------------------------------------------------------
      CALL GETVRM('SP',ARRAY,JARRAY,FLGRAY,JRCD,
     +            JMAC,JMATYP,MATLAYO,LACCFLA)
c
      SIG1 = ARRAY(3)
!-----------------------------------------------------------------------
!     Access equivalent plastic strain
!-----------------------------------------------------------------------
      CALL GETVRM('PE',ARRAY,JARRAY,FLGRAY,JRCD,
     +            JMAC,JMATYP,MATLAYO,LACCFLA)
c
      PEEQ = ARRAY(7)
!-----------------------------------------------------------------------
!     Extract data
!-----------------------------------------------------------------------
      dp     = PEEQ-STATEV(1)
      damage = STATEV(2)
!-----------------------------------------------------------------------
!     Update damage variable
!-----------------------------------------------------------------------
      if(dp.gt.0.0)then
         damage = damage+max(0.0,SIG1)*(dp/Wc)
      endif
!-----------------------------------------------------------------------
!     Update state dependent variables
!-----------------------------------------------------------------------
      STATEV(1) = PEEQ
      STATEV(2) = min(1.0,damage)
!-----------------------------------------------------------------------
!     Check for fracture
!-----------------------------------------------------------------------
      if(damage.ge.1.0)then
         STATEV(3) = 0.0
      else
         STATEV(3) = 1.0
      endif
!-----------------------------------------------------------------------
!     End of subroutine
!-----------------------------------------------------------------------
      RETURN
      END
